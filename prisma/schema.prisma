// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Seed configuration
// Run with: npm run db:seed

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  password  String // Hashed password
  role      Role       @default(USER)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]

  @@index([email])
}

enum Role {
  ADMIN
  USER
}

// Global Settings (da aba Inputs)
model GlobalSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([key])
}

// Fixed Costs (Custos Fixos Mensais da Empresa - da aba Inputs)
// Ex: Aluguel, Escritórios, Luz, Softwares, Viaturas, etc.
model FixedCost {
  id            String    @id @default(cuid())
  name          String // Nome do custo (ex: "Aluguel Escritório Lisboa")
  category      String // Categoria (ex: "Aluguel", "Utilidades", "Software", "Viaturas", "Outros")
  monthlyAmount Decimal   @db.Decimal(12, 2) // Valor mensal em €
  description   String?   @db.Text
  isActive      Boolean   @default(true)
  startDate     DateTime  @default(now()) // Data de início
  endDate       DateTime? // Data de término (null = permanente)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  @@index([category])
  @@index([isActive])
  @@index([startDate, endDate])
}

// Departments (da aba Depts)
model Department {
  id                    String   @id @default(cuid())
  name                  String   @unique
  code                  String?  @unique
  billableHeadcount     Int // HC faturável (pessoas)
  costPerPersonPerMonth Decimal? @db.Decimal(10, 2)
  targetUtilization     Decimal  @default(0.65) @db.Decimal(5, 4) // 0.65 = 65%
  averageHourlyRate     Decimal  @db.Decimal(10, 2) // Taxa média €/h

  // Calculados (não editáveis diretamente)
  directCostAnnual        Decimal? @db.Decimal(12, 2)
  billableHoursAnnual     Decimal? @db.Decimal(10, 2)
  revenueCapacityAnnual   Decimal? @db.Decimal(12, 2)
  overheadAllocatedAnnual Decimal? @db.Decimal(12, 2)
  minimumRevenueAnnual    Decimal? @db.Decimal(12, 2) // Objetivo mínimo

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plannedHours    PlannedHours[]
  objectives      Objective[]
  retainers       Retainer[]
  retainerCatalog RetainerCatalog[]
  results         Result[]
  auditLogs       AuditLog[]
  odooMapping     OdooDepartmentMapping?

  @@index([isActive])
}

// Monthly Planned Hours (da aba Horas Faturáveis – Dept)
model PlannedHours {
  id           String @id @default(cuid())
  departmentId String
  month        Int // 1-12
  year         Int

  // Inputs (editáveis)
  billableHeadcount    Int? // HC faturável no mês
  targetHoursPerMonth  Decimal? @db.Decimal(10, 2) // Horas/mês padrão
  targetUtilization    Decimal? @db.Decimal(5, 4)
  targetAvailableHours Decimal? @db.Decimal(10, 2) // Calculado: HC * horas/mês * utilização

  // Real hours (do Odoo ou manual)
  actualBillableHours Decimal? @db.Decimal(10, 2) // Horas faturáveis registadas (Odoo)
  actualUtilization   Decimal? @db.Decimal(5, 4) // % Utilização (real)
  syncedFromOdoo      Boolean   @default(false) // Indica se foi sincronizado do Odoo
  lastSyncedAt        DateTime? // Última sincronização do Odoo

  // Revenue
  retainerRevenue Decimal? @db.Decimal(12, 2) // Receita recorrente (avenças)
  projectRevenue  Decimal? @db.Decimal(12, 2) // Receita projetos faturada
  totalRevenue    Decimal? @db.Decimal(12, 2) // Receita total
  revenuePerHour  Decimal? @db.Decimal(10, 2) // Receita/hora (real)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, month, year])
  @@index([departmentId, year, month])
  @@index([year, month])
}

// Objectives (objetivos mínimos mensais)
model Objective {
  id           String   @id @default(cuid())
  departmentId String
  month        Int
  year         Int
  targetValue  Decimal  @db.Decimal(12, 2) // Objetivo mínimo em €
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, month, year])
  @@index([departmentId, year, month])
  @@index([year, month])
}

// Retainer Catalog (da aba Catálogo Avenças)
model RetainerCatalog {
  id                 String   @id @default(cuid())
  name               String   @unique
  departmentId       String
  monthlyPrice       Decimal  @db.Decimal(10, 2)
  hoursPerMonth      Decimal  @db.Decimal(10, 2)
  internalHourlyCost Decimal? @db.Decimal(10, 2)
  monthlyCost        Decimal? @db.Decimal(10, 2)
  monthlyMargin      Decimal? @db.Decimal(10, 2)
  marginPercentage   Decimal? @db.Decimal(5, 2)
  baseHours          Decimal? @db.Decimal(10, 2)
  basePrice          Decimal? @db.Decimal(10, 2)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  retainers  Retainer[]

  @@index([departmentId])
  @@index([isActive])
}

// Active Retainers (da aba Avenças)
model Retainer {
  id             String  @id @default(cuid())
  departmentId   String
  catalogId      String? // Referência ao catálogo
  name           String // Nome do cliente/projeto
  type           String? // Tipo de avença/contrato
  monthlyPrice   Decimal @db.Decimal(10, 2)
  quantity       Int     @default(1) // Qtd (ativa)
  monthlyRevenue Decimal @db.Decimal(12, 2) // Calculado: price * quantity

  hoursPerMonth        Decimal? @db.Decimal(10, 2) // Horas/mês (entrega)
  variableCostPerMonth Decimal? @db.Decimal(10, 2) // Custo variável/mês

  // Growth model
  monthlyChurn         Decimal? @default(0.03) @db.Decimal(5, 4) // Churn mensal (ex.: 0,03)
  newRetainersPerMonth Int?     @default(0) // Novas avenças / mês

  startDate DateTime
  endDate   DateTime?
  isActive  Boolean   @default(true)
  notes     String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  catalog    RetainerCatalog? @relation(fields: [catalogId], references: [id], onDelete: SetNull)

  @@index([departmentId, isActive])
  @@index([isActive, startDate])
  @@index([startDate, endDate])
}

// Calculated Results (read-only, computed)
model Result {
  id           String @id @default(cuid())
  departmentId String
  month        Int
  year         Int

  // Inputs (snapshot)
  plannedHours    Decimal? @db.Decimal(10, 2)
  actualHours     Decimal? @db.Decimal(10, 2)
  hourlyRate      Decimal  @db.Decimal(10, 2)
  activeRetainers Decimal  @db.Decimal(12, 2) // Sum of active retainers
  projectRevenue  Decimal? @db.Decimal(12, 2)

  // Calculated
  revenueFromHours Decimal? @db.Decimal(12, 2) // actualHours * hourlyRate
  totalRevenue     Decimal  @db.Decimal(12, 2) // revenueFromHours + activeRetainers + projectRevenue

  // Comparison
  objective       Decimal? @db.Decimal(12, 2) // Objective.targetValue if exists
  performance     Decimal? @db.Decimal(5, 2) // (totalRevenue / objective) * 100
  utilizationRate Decimal? @db.Decimal(5, 4) // actualHours / availableHours

  // Metadata
  calculatedAt DateTime @default(now())
  calculatedBy String? // User ID or "system"

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, month, year])
  @@index([departmentId, year, month])
  @@index([year, month])
}

// Audit Trail
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  entityType String // "Department", "Objective", "PlannedHours", "Retainer", etc.
  entityId   String
  action     String // "CREATE", "UPDATE", "DELETE"
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now())

  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId String?
  FixedCost    FixedCost?  @relation(fields: [fixedCostId], references: [id])
  fixedCostId  String?

  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId])
  @@index([departmentId])
}

// Odoo Integration Configuration
model OdooIntegration {
  id                String   @id @default(cuid())
  isEnabled          Boolean  @default(false)
  baseUrl            String   // URL base do Odoo (ex: https://odoo.example.com)
  database           String   // Nome do banco de dados
  username           String   // Usuário para autenticação
  password           String   // Senha (criptografada)
  apiType            String   @default("xmlrpc") // "xmlrpc" ou "jsonrpc"
  syncFrequency     String?  // "manual", "daily", "weekly" (para futuras implementações)
  lastSyncAt         DateTime?
  lastSyncStatus     String?  // "success", "error"
  lastSyncError      String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  departmentMappings OdooDepartmentMapping[]

  @@index([isEnabled])
}

// Mapeamento de Departamentos: Odoo <-> RED Metrics
model OdooDepartmentMapping {
  id                String   @id @default(cuid())
  odooIntegrationId String
  departmentId      String   @unique // Departamento no RED Metrics
  odooDepartmentId  Int      // ID do departamento no Odoo
  odooDepartmentName String? // Nome do departamento no Odoo (para referência)
  mappingType       String   @default("id") // "id", "name", "code"
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  odooIntegration OdooIntegration @relation(fields: [odooIntegrationId], references: [id], onDelete: Cascade)
  department     Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@index([odooIntegrationId])
  @@index([departmentId])
  @@index([isActive])
}
